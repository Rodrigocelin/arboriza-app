<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relat√≥rio T√©cnico - ArborizaApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Meta tag atualizada para compatibilidade com PWA em dispositivos m√≥veis -->
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        /* Estilos CSS Base */
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: #f9f9f9;
            color: #333;
            line-height: 1.6;
            box-sizing: border-box; /* Garante que padding e border sejam inclu√≠dos na largura/altura */
            min-width: 320px; /* Garante que a p√°gina n√£o fique muito pequena */
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2e7d32;
            font-size: 1.8em;
        }
        h2 {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
            color: #2e7d32;
            font-size: 1.5em;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 15px; /* Aumenta um pouco o espa√ßamento */
            margin-bottom: 5px;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px; /* Aumenta o padding para melhor toque */
            margin-top: 4px;
            border-radius: 6px; /* Bordas mais arredondadas */
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease; /* Transi√ß√£o suave na borda */
        }
        input:focus, textarea:focus, select:focus {
            border-color: #43a047; /* Destaca a borda ao focar */
            outline: none;
        }
        button {
            margin-top: 20px; /* Aumenta o espa√ßamento */
            padding: 12px 20px; /* Aumenta o padding para melhor toque */
            font-size: 1.1rem; /* Fonte um pouco maior */
            background: #43a047;
            color: white;
            border: none;
            border-radius: 6px; /* Bordas mais arredondadas */
            cursor: pointer;
            transition: background 0.3s ease; /* Transi√ß√£o suave no hover */
            display: inline-block; /* Permite que os bot√µes fiquem na mesma linha */
            width: auto; /* Permite que o bot√£o se ajuste ao conte√∫do */
            margin-left: auto; /* Centraliza o bot√£o */
            margin-right: auto; /* Centraliza o bot√£o */
        }
        button:hover {
            background: #2e7d32;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .voice-button {
            margin-top: 8px; /* Ajusta o espa√ßamento do bot√£o de voz */
            margin-bottom: 15px;
            display: inline-block;
            width: auto;
            padding: 8px 12px; /* Padding menor para bot√µes menores */
            font-size: 0.9em;
            background: #007bff; /* Cor diferente para diferenciar */
        }
        .voice-button:hover {
            background: #0056b3;
        }
        /* Estilo para o novo bot√£o de limpar campo de texto de observa√ß√£o da √°rvore */
        .clear-obs-arvore-button {
            margin-top: 8px;
            margin-bottom: 15px;
            display: inline-block;
            width: auto;
            padding: 8px 12px;
            font-size: 0.9em;
            background: #f0ad4e; /* Uma cor de aviso/limpeza */
            margin-left: 10px; /* Espa√ßamento do bot√£o de voz */
        }
        .clear-obs-arvore-button:hover {
            background: #ec971f;
        }


        #mapaInterativo {
            height: 350px; /* Altura padr√£o para desktop */
            width: 100%;
            margin-top: 15px;
            border: 1px solid #ccc;
            border-radius: 8px; /* Bordas mais arredondadas */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Sombra suave */
        }
        .preview-fotos {
            display: flex;
            gap: 15px; /* Aumenta o espa√ßamento entre as fotos */
            margin-top: 15px;
            flex-wrap: wrap; /* Garante que as fotos quebrem a linha */
            justify-content: center; /* Centraliza as fotos */
        }
        .preview-fotos .photo-item { /* Novo container para foto + descri√ß√£o + bot√µes */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .preview-fotos img {
            width: 120px; /* Tamanho ligeiramente maior para desktop */
            height: 90px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .preview-fotos textarea { /* Estilo para o campo de descri√ß√£o da foto */
            width: 100%;
            min-height: 40px;
            font-size: 0.9em;
            resize: vertical;
            margin-top: 5px;
        }
        .preview-fotos .photo-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .preview-fotos .photo-actions button {
            margin: 0;
            padding: 5px 10px;
            font-size: 0.8em;
            background-color: #007bff;
        }
        .preview-fotos .photo-actions button:hover {
            background-color: #0056b3;
        }

        #loadingMessage, #loadingLocation {
            display: none;
            color: #43a047;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        #loadingLocation {
            text-align: left;
            display: inline-block;
            margin-left: 10px;
        }
        /* Estilos adicionais para os blocos de √°rvores */
        .arvore-item {
            border: 1px solid #e0e0e0;
            padding: 20px; /* Aumenta o padding */
            margin-bottom: 20px; /* Aumenta o espa√ßamento */
            border-radius: 10px; /* Bordas mais arredondadas */
            background-color: #ffffff;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* Sombra mais pronunciada */
        }
        .arvore-item h3 {
            margin-top: 0;
            color: #2e7d32;
            font-size: 1.2em; /* Fonte um pouco maior */
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0; /* Linha divis√≥ria */
            padding-bottom: 10px;
        }
        .arvore-item .remove-arvore {
            background-color: #d32f2f;
            position: absolute;
            top: 15px; /* Ajusta a posi√ß√£o */
            right: 15px; /* Ajusta a posi√ß√£o */
            padding: 8px 15px; /* Aumenta o padding */
            font-size: 0.9em;
            margin-top: 0;
            border-radius: 5px;
        }
        .arvore-item .remove-arvore:hover {
            background-color: #b71c1c;
        }

        /* Estilos para os campos de sele√ß√£o/adi√ß√£o din√¢mica (Diagn√≥stico e Indica√ß√£o) */
        .selected-tags-container {
            margin-top: 15px; /* Aumenta o espa√ßamento */
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 8px; /* Bordas mais arredondadas */
            min-height: 60px; /* Garante que a caixa seja vis√≠vel mesmo vazia */
            background-color: #fcfcfc;
        }
        .tag-item {
            display: inline-block;
            background-color: #e0e0e0;
            padding: 8px 12px; /* Aumenta o padding */
            margin: 6px; /* Aumenta o espa√ßamento */
            border-radius: 20px; /* Mais arredondado */
            font-size: 0.95em;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .tag-item button {
            background: none;
            border: none;
            color: #d32f2f;
            font-weight: bold;
            margin-left: 8px; /* Aumenta o espa√ßamento */
            padding: 0;
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
            vertical-align: middle;
            margin-top: -2px;
        }
        .tag-item button:hover {
            color: #b71c1c;
            background: none;
        }
        .add-section {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .add-section select {
            flex-grow: 1;
        }
        .add-section button {
            margin-top: 0; /* Remove margin-top extra */
            padding: 10px 15px; /* Ajusta padding */
            font-size: 0.95em;
            white-space: nowrap;
        }

        /* Classe para ocultar campos no modo Plantio */
        .campo-plantio-oculto {
            display: none !important;
        }

        /* Nova classe para controlar a visibilidade dos campos espec√≠ficos de Plantio */
        .campo-condicional-plantio {
            border: 1px dashed #a5d6a7; /* Borda mais verde */
            padding: 20px;
            margin-top: 20px;
            border-radius: 10px;
            background-color: #e8f5e9; /* Um fundo verde mais suave */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Estilos para o grupo de refer√™ncia */
        .reference-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap; /* Permite que os itens quebrem a linha em telas pequenas */
        }
        .reference-group select, .reference-group input {
            flex-grow: 1;
            min-width: 150px; /* Garante um tamanho m√≠nimo em telas pequenas */
        }

        /* Container para input e bot√£o de voz para o campo Endere√ßo */
        .input-with-voice-button {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .input-with-voice-button input {
            flex-grow: 1;
        }
        .input-with-voice-button .voice-button {
            margin-top: 0;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        /* Estilos para o Modal de Desenho */
        .drawing-modal-overlay {
            display: none; /* Oculto por padr√£o */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .drawing-modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .drawing-modal-content canvas {
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .drawing-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .drawing-controls input[type="color"] {
            width: 50px;
            height: 30px;
            padding: 0;
            border: none;
        }

        .drawing-controls input[type="range"] {
            width: 100px;
        }

        .drawing-controls button {
            margin-top: 0;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .drawing-controls button.cancel-button {
            background-color: #f44336;
        }
        .drawing-controls button.cancel-button:hover {
            background-color: #d32222;
        }
        /* Estilos para os bot√µes de ferramenta de desenho */
        .tool-button {
            background-color: #6c757d; /* Cinza para ferramentas inativas */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .tool-button.active {
            background-color: #43a047; /* Verde para a ferramenta ativa */
        }
        .tool-button:hover {
            background-color: #5a6268;
        }


        /* Media Queries para Responsividade */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            h1 {
                font-size: 1.6em;
            }
            label {
                margin-top: 10px;
            }
            input, textarea, select {
                padding: 8px;
                font-size: 0.95rem;
            }
            button {
                padding: 10px 15px;
                font-size: 1rem;
            }
            .voice-button, .clear-obs-arvore-button { /* Aplica estilo aos dois bot√µes na linha da obs da arvore */
                padding: 6px 10px;
                font-size: 0.85em;
            }
            #mapaInterativo {
                height: 250px; /* Altura menor para mobile */
                margin-top: 10px;
            }
            .preview-fotos {
                gap: 10px;
            }
            .preview-fotos .photo-item {
                padding: 8px;
            }
            .preview-fotos img {
                width: 90px;
                height: 67px;
            }
            .preview-fotos textarea {
                font-size: 0.85em;
            }
            .arvore-item {
                padding: 15px;
                margin-bottom: 15px;
            }
            .arvore-item h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
                padding-bottom: 8px;
            }
            .arvore-item .remove-arvore {
                padding: 6px 12px;
                font-size: 0.75em;
                top: 10px;
                right: 10px;
            }
            .selected-tags-container {
                min-height: 40px;
                padding: 8px;
            }
            .tag-item {
                padding: 6px 10px;
                margin: 4px;
                font-size: 0.85em;
            }
            .tag-item button {
                font-size: 1em;
            }
            .add-section button {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .input-with-voice-button {
                flex-direction: column; /* Empilha input e button em telas muito pequenas */
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 1.4em;
            }
            .reference-group {
                flex-direction: column; /* Empilha select e input em telas muito pequenas */
                align-items: stretch;
            }
            .reference-group select, .reference-group input {
                min-width: unset; /* Remove min-width para flexibilidade total */
            }
            .preview-fotos img {
                width: 80px;
                height: 60px;
            }
            .add-section {
                flex-direction: column; /* Empilha select e button */
                align-items: stretch;
            }
            button {
                display: block; /* For√ßa bot√µes a ocuparem linha inteira em telas pequenas */
                margin-left: 0;
                margin-right: 0;
                width: 100%;
            }
            .drawing-modal-content {
                padding: 10px;
            }
            .drawing-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .drawing-controls input[type="range"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>RELAT√ìRIO T√âCNICO</h1>
    <form id="formRelatorio">
        <label>Ref.:</label>
        <div class="reference-group">
            <select id="tipoReferencia">
                <option value="Processo">Processo</option>
                <option value="SIC">SIC</option>
                <option value="Protocolo">Protocolo</option>
                <option value="Demanda Interna">Demanda Interna</option>
                <option value="Indica√ß√£o">Indica√ß√£o</option>
            </select>
            <input type="text" id="numeroReferencia" placeholder="N√∫mero da refer√™ncia" />
        </div>

        <label for="numero">Relat√≥rio N¬∫.:</label>
        <input type="text" id="numero" required readonly />

        <label for="servico">Servi√ßo:</label>
        <select type="text" id="servico" required>
            <option value="">Selecione um servi√ßo...</option>
            <option value="Poda">Poda</option>
            <option value="Retirada">Retirada</option>
            <option value="√Årea livre">√Årea livre</option>
            <option value="Tratamento Fitossanit√°rio">Tratamento Fitossanit√°rio</option>
            <option value="Plantio">Plantio</option>
            <option value="Outros">Outros</option>
        </select>

        <label for="bairro">Bairro:</label>
        <!-- CAMPO BAIRRO AGORA COM DATALIST -->
        <input type="text" id="bairro" list="listaBairros" required />
        <datalist id="listaBairros">
            <option value="Aeroporto"></option>
            <option value="Alagoano"></option>
            <option value="Andorinhas"></option>
            <option value="Ant√¥nio Hon√≥rio"></option>
            <option value="Ariovaldo Favalessa"></option>
            <option value="Barro Vermelho"></option>
            <option value="Bela Vista"></option>
            <option value="Bento Ferreira"></option>
            <option value="Boa Vista"></option>
            <option value="Bonfim"></option>
            <option value="Carato√≠ra"></option>
            <option value="Centro"></option>
            <option value="Comdusa"></option>
            <option value="Consola√ß√£o"></option>
            <option value="Conquista"></option>
            <option value="Cruzamento"></option>
            <option value="Da Penha"></option>
            <option value="De Lourdes"></option>
            <option value="Do Cabral"></option>
            <option value="Do Moscoso"></option>
            <option value="Do Quadro"></option>
            <option value="Enseada do Su√°"></option>
            <option value="Estrelinha"></option>
            <option value="Forte S√£o Jo√£o"></option>
            <option value="Fonte Grande"></option>
            <option value="Fradinhos"></option>
            <option value="Goiabeiras"></option>
            <option value="Grande Vit√≥ria"></option>
            <option value="Gurigica"></option>
            <option value="Horto"></option>
            <option value="Ilha das Caieiras"></option>
            <option value="Ilha de Santa Maria"></option>
            <option value="Ilha do Boi"></option>
            <option value="Ilha do Frade"></option>
            <option value="Ilha do Pr√≠ncipe"></option>
            <option value="Inhanguet√°"></option>
            <option value="Itarar√©"></option>
            <option value="Jabour"></option>
            <option value="Jardim Camburi"></option>
            <option value="Jardim da Penha"></option>
            <option value="Jesus de Nazareth"></option>
            <option value="Joana d'Arc"></option>
            <option value="Jucutuquara"></option>
            <option value="Maru√≠pe"></option>
            <option value="Maria Ortiz"></option>
            <option value="M√°rio Cypreste"></option>
            <option value="Mata da Praia"></option>
            <option value="Monte Belo"></option>
            <option value="Morada de Camburi"></option>
            <option value="Nazareth"></option>
            <option value="Nova Palestina"></option>
            <option value="Parque Industrial"></option>
            <option value="Parque Moscoso"></option>
            <option value="Piedade"></option>
            <option value="Pontal de Camburi"></option>
            <option value="Praia do Canto"></option>
            <option value="Praia do Su√°"></option>
            <option value="Reden√ß√£o"></option>
            <option value="Rep√∫blica"></option>
            <option value="Resist√™ncia"></option>
            <option value="Rom√£o"></option>
            <option value="Santa Cec√≠lia"></option>
            <option value="Santa Clara"></option>
            <option value="Santa Helena"></option>
            <option value="Santa L√∫cia"></option>
            <option value="Santa Lu√≠za"></option>
            <option value="Santa Martha"></option>
            <option value="Santa Tereza"></option>
            <option value="Santo Andr√©"></option>
            <option value="Santo Ant√¥nio"></option>
            <option value="Santos Dumont"></option>
            <option value="Santos Reis"></option>
            <option value="S√£o Benedito"></option>
            <option value="S√£o Crist√≥v√£o"></option>
            <option value="S√£o Jos√©"></option>
            <option value="S√£o Pedro"></option>
            <option value="Seguran√ßa do Lar"></option>
            <option value="Solon Borges"></option>
            <option value="Tabuazeiro"></option>
            <option value="Universit√°rio"></option>
            <option value="Vila Rubim"></option>
        </datalist>
        <!-- FIM DO CAMPO BAIRRO COM DATALIST -->

        <label for="endereco">Endere√ßo:</label>
        <div class="input-with-voice-button">
            <input type="text" id="endereco" required />
            <button type="button" onclick="transcreverVozParaTexto('endereco')" class="voice-button">üé§ Falar</button>
        </div>

        <div id="arvoresContainer">
        </div>

        <button type="button" id="btnAddArvore" style="margin-bottom: 20px;">+ Adicionar √Årvore</button>

        <label>Localiza√ß√£o atual:</label>
        <button type="button" id="btnObterLocalizacao" onclick="obterLocalizacao()">üìç Obter Localiza√ß√£o</button>
        <span id="loadingLocation">Obtendo localiza√ß√£o...</span>
        <div id="mapaInterativo"></div>

        <label>Fotos do Local (at√© 4):</label>
        <!-- Cada input de foto agora tem um container para a pr√©-visualiza√ß√£o, descri√ß√£o e bot√£o de edi√ß√£o -->
        <div class="photo-input-group">
            <input type="file" id="foto1" accept="image/*" capture="environment" />
            <textarea id="descricaoFoto1" rows="2" placeholder="Descri√ß√£o da Foto 1"></textarea>
        </div>
        <div class="photo-input-group">
            <input type="file" id="foto2" accept="image/*" capture="environment" />
            <textarea id="descricaoFoto2" rows="2" placeholder="Descri√ß√£o da Foto 2"></textarea>
        </div>
        <div class="photo-input-group">
            <input type="file" id="foto3" accept="image/*" capture="environment" />
            <textarea id="descricaoFoto3" rows="2" placeholder="Descri√ß√£o da Foto 3"></textarea>
        </div>
        <div class="photo-input-group">
            <input type="file" id="foto4" accept="image/*" capture="environment" />
            <textarea id="descricaoFoto4" rows="2" placeholder="Descri√ß√£o da Foto 4"></textarea>
        </div>
        <div id="previewFotos" class="preview-fotos"></div>

        <label for="tecnico">Respons√°vel T√©cnico:</label>
        <input type="text" id="tecnico" required />

        <label for="dataFinal">Data de Emiss√£o:</label>
        <input type="date" id="dataFinal" required />

        <button type="button" id="btnGerarPdf">Gerar PDF</button>
        <button type="button" id="limparParaProximaArvoreBtn" style="background-color: #f44336; margin-left: 10px;">Limpar para Pr√≥xima √Årvore</button>
        <div id="loadingMessage">Gerando PDF, aguarde...</div>
    </form>

    <!-- Modal de Desenho -->
    <div id="drawingModalOverlay" class="drawing-modal-overlay">
        <div class="drawing-modal-content">
            <h3>Editar Desenho</h3>
            <canvas id="drawingCanvas"></canvas>
            <div class="drawing-controls">
                <label>Ferramenta:</label>
                <button type="button" id="toolLineBtn" class="tool-button active" data-tool="line">Linha</button>
                <button type="button" id="toolCircleBtn" class="tool-button" data-tool="circle">C√≠rculo</button>
                <button type="button" id="toolArrowBtn" class="tool-button" data-tool="arrow">Seta</button>

                <label for="brushColor">Cor:</label>
                <input type="color" id="brushColor" value="#FF0000">
                <label for="brushSize">Tamanho:</label>
                <input type="range" id="brushSize" min="1" max="20" value="5">
                <button type="button" id="clearCanvasBtn">Limpar</button>
                <button type="button" id="saveDrawingBtn">Salvar</button>
                <button type="button" id="cancelDrawingBtn" class="cancel-button">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let mapa, marcador, latGlobal, lngGlobal;

        // Armazena os dados das √°rvores, incluindo seus diagn√≥sticos, indica√ß√µes e OBS
        let arvoresData = [];
        let arvoreCounter = 0; // Para dar IDs √∫nicos a cada conjunto de campos de √°rvore (n√£o para a numera√ß√£o visual)

        // NOVAS VARI√ÅVEIS PARA MANIPULA√á√ÉO DE FOTOS E DESENHO
        let photoDescriptions = ['', '', '', '']; // Array para armazenar as descri√ß√µes das 4 fotos
        let editedPhotoDataUrls = [null, null, null, null]; // Armazena as Data URLs das fotos editadas
        let currentEditingPhotoIndex = -1; // √çndice da foto atualmente sendo editada no modal

        // Vari√°veis para o canvas de desenho
        let drawingCanvas, drawingCtx;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let startX = 0, startY = 0; // Para desenhar formas
        let currentTool = 'line'; // Ferramenta de desenho atual: 'line', 'circle', 'arrow'
        let drawnShapes = []; // Array para armazenar todas as formas desenhadas (permanentes)

        // Fun√ß√£o auxiliar para adicionar texto a um campo com quebra de linha
        function appendTextToField(fieldId, text) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value += (field.value ? "\n" : "") + text;
            }
        }

        // Fun√ß√£o para transcrever voz para texto (campo obsArvore-${arvoreCounter} ou observacoesCampo)
        function transcreverVozParaTexto(idCampo) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Seu navegador n√£o suporta reconhecimento de voz ou a conex√£o n√£o √© segura (HTTPS). Por favor, use um navegador moderno e uma conex√£o segura.");
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.start();
            recognition.onresult = e => {
                appendTextToField(idCampo, e.results[0][0].transcript);
            };
            recognition.onerror = e => {
                console.error("Erro no reconhecimento de voz:", e.error);
                alert("Ocorreu um erro no reconhecimento de voz. Verifique se a conex√£o √© HTTPS e se voc√™ deu permiss√£o para o microfone. Erro: " + e.error);
            };
            recognition.onend = () => {
                console.log("Reconhecimento de voz encerrado.");
            };
        }

        // Fun√ß√£o para obter a localiza√ß√£o atual e exibir no mapa
        function obterLocalizacao() {
            const btnObterLocalizacao = document.getElementById('btnObterLocalizacao');
            const loadingLocationSpan = document.getElementById('loadingLocation');

            btnObterLocalizacao.disabled = true;
            loadingLocationSpan.style.display = 'inline';

            if (!navigator.geolocation) {
                alert("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.");
                btnObterLocalizacao.disabled = false;
                loadingLocationSpan.style.display = 'none';
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                latGlobal = pos.coords.latitude;
                lngGlobal = pos.coords.longitude;

                if (!mapa) {
                    mapa = L.map('mapaInterativo').setView([latGlobal, lngGlobal], 19);
                    // Restaurando para OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        crossOrigin: true
                    }).addTo(mapa);
                    
                    marcador = L.marker([latGlobal, lngGlobal]).addTo(mapa);
                } else {
                    mapa.setView([latGlobal, lngGlobal], 19);
                    marcador.setLatLng([latGlobal, lngGlobal]);
                }
                btnObterLocalizacao.disabled = false;
                loadingLocationSpan.style.display = 'none';
            }, err => {
                alert("Erro ao obter localiza√ß√£o: " + err.message + ". Verifique se voc√™ deu permiss√£o para a localiza√ß√£o no seu navegador e nas configura√ß√µes do seu celular.");
                console.error("Erro de geolocaliza√ß√£o:", err);
                btnObterLocalizacao.disabled = false;
                loadingLocationSpan.style.display = 'none';
            });
        }

        // Fun√ß√£o para comprimir imagens
        async function compressImage(file, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = () => reject("Erro ao carregar a imagem para compress√£o.");
                    reader.onerror = () => reject("Erro ao ler o arquivo de imagem.");
                };
                reader.readAsDataURL(file);
            });
        }

        // --- FUN√á√ïES PARA GERENCIAR A CONTAGEM AUTOM√ÅTICA DO RELAT√ìRIO ---

        /**
         * Obt√©m o n√∫mero do relat√≥rio atual do localStorage.
         * N√£o incrementa nem salva.
         * @returns {number} O n√∫mero do relat√≥rio. Retorna 0 se n√£o houver dados ou o ano mudou.
         */
        function getReportNumberFromStorage() {
            const currentYear = new Date().getFullYear();
            let lastReportData = localStorage.getItem('arborizaAppReportNumber');
            let reportNumber = 0; // Default para 0

            if (lastReportData) {
                try {
                    const data = JSON.parse(lastReportData);
                    if (data.year === currentYear) {
                        reportNumber = data.number;
                    }
                } catch (e) {
                    console.error("Erro ao parsear dados do relat√≥rio do LocalStorage:", e);
                }
            }
            return reportNumber;
        }

        /**
         * Salva um n√∫mero de relat√≥rio espec√≠fico no localStorage.
         * @param {number} number O n√∫mero a ser salvo.
         */
        function setReportNumberInStorage(number) {
            const currentYear = new Date().getFullYear();
            localStorage.setItem('arborizaAppReportNumber', JSON.stringify({ number: number, year: currentYear }));
        }

        /**
         * Exibe o n√∫mero do relat√≥rio atual no campo de input.
         * Garante que o localStorage tenha um n√∫mero v√°lido (come√ßa em 1 se vazio/novo ano).
         */
        function displayCurrentReportNumber() {
            let currentNumber = getReportNumberFromStorage();
            const currentYear = new Date().getFullYear();

            if (currentNumber === 0) { // Se n√£o h√° dados ou ano novo, define como 1
                currentNumber = 1;
                setReportNumberInStorage(currentNumber); // Salva 1 no localStorage
            }
            document.getElementById("numero").value = `${currentNumber}/${currentYear}`;
        }

        /**
         * Incrementa o n√∫mero do relat√≥rio no localStorage e o exibe no campo.
         * Se for a primeira vez ou novo ano, come√ßa do 1.
         */
        function incrementAndDisplayNextReportNumber() {
            let currentNumber = getReportNumberFromStorage();
            const currentYear = new Date().getFullYear();

            // Se for o in√≠cio de um novo ano, ou se n√£o houver n√∫mero salvo, come√ßa do 1.
            // Caso contr√°rio, apenas incrementa.
            if (currentNumber === 0) {
                currentNumber = 1;
            } else {
                currentNumber++;
            }

            setReportNumberInStorage(currentNumber); // Salva o novo n√∫mero
            document.getElementById("numero").value = `${currentNumber}/${currentYear}`; // Exibe
        }

        // Fun√ß√£o gen√©rica para adicionar um item a uma lista espec√≠fica de uma √°rvore
        function addItemToList(selectId, treeId, type) { // type: 'diagnoses' or 'indications'
            const select = document.getElementById(selectId);
            const itemValue = select.value;
            const itemText = select.options[select.selectedIndex].text;
            const containerDiv = document.getElementById(`${type}Selecionados-${treeId}`);

            const arvore = arvoresData.find(a => a.id === treeId);
            if (!arvore) return;

            const listArray = arvore[type]; // reference to either arvore.diagnoses or arvore.indications

            if (itemValue && !listArray.includes(itemValue)) {
                listArray.push(itemValue);

                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag-item');
                tagDiv.dataset.value = itemValue;
                tagDiv.innerHTML = `${itemText} <button type="button" class="remove-tag">x</button>`;
                containerDiv.appendChild(tagDiv);

                // Adiciona listener para o bot√£o de remover
                tagDiv.querySelector('.remove-tag').addEventListener('click', () => {
                    removeItemFromList(itemValue, treeId, type, tagDiv);
                });

                select.value = ""; // Reseta o select
            }
        }

        // Fun√ß√£o gen√©rica para remover um item de uma lista espec√≠fica de uma √°rvore
        function removeItemFromList(valueToRemove, treeId, type, elementToRemove) {
            const arvore = arvoresData.find(a => a.id === treeId);
            if (!arvore) return;

            const listArray = arvore[type];
            const index = listArray.indexOf(valueToRemove);
            if (index > -1) {
                listArray.splice(index, 1); // Remove apenas 1 item no √≠ndice encontrado
            }
            elementToRemove.remove(); // Remove o elemento visual
        }

        // Fun√ß√£o para atualizar os t√≠tulos das √°rvores (√Årvore 1, √Årvore 2, etc.)
        function updateArvoreTitles() {
            const arvoreItems = document.querySelectorAll('.arvore-item');
            const newArvoresData = []; // Cria um novo array para a ordem correta

            arvoreItems.forEach((item, index) => {
                // Atualiza o t√≠tulo H3 visual
                item.querySelector('h3').innerText = `√Årvore ${index + 1}`;

                // Recria o arvoresData na ordem correta, mantendo os dados associados
                const originalTreeId = item.id; // Ex: arvore-1, arvore-5, etc.
                const existingData = arvoresData.find(a => a.id === originalTreeId);
                if (existingData) {
                    newArvoresData.push(existingData);
                } else {
                    // Isso n√£o deveria acontecer se a l√≥gica de remo√ß√£o estiver correta,
                    // mas √© um fallback.
                    console.warn(`Dados para ${originalTreeId} n√£o encontrados em arvoresData.`);
                    newArvoresData.push({
                        id: originalTreeId,
                        especie: "",
                        quantidade: 0,
                        posicao: "",
                        altura: null,
                        cap: null,
                        diagnoses: [],
                        indications: [],
                        obsArvore: "",
                        aberturaAreaLivre: "", // Adicionado para plantio
                        larguraCalcada: null // Adicionado para plantio
                    });
                }
            });
            arvoresData = newArvoresData; // Atualiza o array global de dados
            console.log("DEBUG: arvoresData ap√≥s updateTitles:", arvoresData); // Para depura√ß√£o
        }

        // NOVO: Fun√ß√£o para controlar a visibilidade do campo Largura da Cal√ßada
        function updateLarguraCalcadaVisibility(treeId) {
            const selectServico = document.getElementById('servico');
            const isPlantio = (selectServico.value === 'Plantio');

            const aberturaAreaLivreSelect = document.getElementById(`aberturaAreaLivre-${treeId.split('-')[1]}`);
            const larguraCalcadaLabel = aberturaAreaLivreSelect.nextElementSibling; // O label da Largura da Cal√ßada
            const larguraCalcadaInput = document.getElementById(`larguraCalcada-${treeId.split('-')[1]}`);

            const posicaoSelect = document.getElementById(`posicao-${treeId.split('-')[1]}`);

            // Condi√ß√£o para exibir Largura da Cal√ßada:
            // - √â servi√ßo de Plantio
            // E (
            //   - Abertura de √Årea Livre √© '√Årea pavimentada'
            //   OU
            //   - Posi√ß√£o √© 'Cal√ßada'
            // )
            const shouldShowLarguraCalcada = isPlantio &&
                (aberturaAreaLivreSelect.value === '√Årea pavimentada' || posicaoSelect.value === 'Cal√ßada');

            if (shouldShowLarguraCalcada) {
                larguraCalcadaLabel.style.display = 'block';
                larguraCalcadaInput.style.display = 'block';
                larguraCalcadaInput.setAttribute('required', 'required');
            } else {
                larguraCalcadaLabel.style.display = 'none';
                larguraCalcadaInput.style.display = 'none';
                larguraCalcadaInput.removeAttribute('required');
                larguraCalcadaInput.value = ''; // Limpa o valor quando oculto
            }
        }


        // Fun√ß√£o para adicionar um novo bloco de campos de √°rvore
        function addArvoreFields() {
            arvoreCounter++; // Incrementa para um ID √∫nico para o elemento DOM
            const currentTreeId = `arvore-${arvoreCounter}`;
            const container = document.getElementById('arvoresContainer');

            const arvoreDiv = document.createElement('div');
            arvoreDiv.id = currentTreeId;
            arvoreDiv.classList.add('arvore-item');

            // Lista de esp√©cies de √°rvores, em ordem alfab√©tica e sem mistura com bairros
            const especies = [
                "Abacateiro",
                "Acacia Auriculiformis",
                "Acacia Mangium",
                "Alb√≠zia",
                "Algod√£o da Praia",
                "Angico Cangalha", // Nova esp√©cie adicionada
                "√Årvore Mastro",
                "√Årvore Samambaia",
                "Cajueiro",
                "Casuarina",
                "Cassia Ferruginea",
                "Cassia Grande",
                "Cassia Javanesa",
                "Castanheira",
                "Castanheira Molulo",
                "Chuva de Ouro",
                "Clerodendron",
                "Coqueiro",
                "Craibeira",
                "Dilenia",
                "Escova de Garrafa",
                "Ficus Bejamina",
                "Ficus Elastica",
                "F√≠cus Lyrata",
                "F√≠cus Microcarpa",
                "Flamboyant",
                "Flor de Rainha",
                "Goiabeira",
                "Ip√™ Amarelo",
                "Ip√™ Amarelo Cascudo",
                "Ip√™ Branco",
                "Ip√™ de Jardim",
                "Ip√™ Rosa",
                "Ip√™ Roxo",
                "Ip√™ Roxo de Bola",
                "Jamel√£o",
                "Jangada do Campo",
                "Jaqueira",
                "Jasmim Caf√©",
                "Jasmim do Caribe",
                "Jasmim Manga",
                "Leucena",
                "Lof√¢ntera",
                "Magn√≥lia Amarela",
                "Magn√≥lia Branca",
                "Manac√° de Cheiro",
                "Mangueira",
                "Morta",
                "N√£o Identificada",
                "Nim",
                "Oiti",
                "Outra",
                "Paineira",
                "Paineira Vermelha",
                "Palmeira A√ßai",
                "Palmeira Areca Bamb√∫",
                "Palmeira Beatriz",
                "Palmeira Bismarck",
                "Palmeira Coco de Quarta",
                "Pata de Vaca",
                "Pata de Vaca Branca",
                "Pau Formiga",
                "Quaresmeira",
                "Sam√¢nia",
                "Sibipiruna",
                "Tesp√©sia",
                "Uva da Praia"
            ].sort(); // Ordena alfabeticamente

            let especiesOptions = '<option value="">Selecione a Esp√©cie</option>';
            especies.forEach(especie => {
                especiesOptions += `<option value="${especie}">${especie}</option>`;
            });

            let posicoesOptions = `
                <option value="">Selecione a Posi√ß√£o</option>
                <option value="Cal√ßada">Cal√ßada</option>
                <option value="Canteiro Central">Canteiro Central</option>
                <option value="Canteiro Lateral">Canteiro Lateral</option>
                <option value="Recanto">Recanto</option>
                <option value="Rotat√≥ria/Trevo">Rotat√≥ria/Trevo</option>
                <option value="Alameda">Alameda</option>
                <option value="Orla">Orla</option>
                <option value="√Årea Livre">√Årea Livre</option>
            `;

            let diagnosticoOptions = `
                <option value="">Selecione um diagn√≥stico para adicionar...</option>
                <option value="√Årea livre em desconformidade com as diretrizes t√©cnicas">√Årea livre em desconformidade com as diretrizes t√©cnicas</option>
                <option value="Vegetal com problemas no tutoramento">Vegetal com problemas no tutoramento</soption>
                <option value="Vegetal morto">Vegetal morto</option>
                <option value="Vegetal Inclinado">Vegetal Inclinado</option>
                <option value="Vegetal inclinado em dire√ß√£o √† resid√™ncia">Vegetal inclinado em dire√ß√£o √† resid√™ncia</option>
                <option value="Vegetal inclinado em dire√ß√£o √† via p√∫blica">Vegetal inclinado em dire√ß√£o √† via p√∫blica</option>
                <option value="Vegetal com les√£o necr√≥tica no tronco">Vegetal com les√£o necr√≥tica no tronco</option>
                <option value="Vegetal com les√£o necr√≥tica em galhos">Vegetal com les√£o necr√≥tica em galhos</option>
                <option value="Vegetal com les√£o necr√≥tica e perda de tecidos (oco)">Vegetal com les√£o necr√≥tica e perda de tecidos (oco)</option>
                <option value="Vegetal com inj√∫ria mec√¢nica">Vegetal com inj√∫ria mec√¢nica</option>
                <option value="Vegetal com indicativo de inj√∫ria qu√≠mica">Vegetal com indicativo de inj√∫ria qu√≠mica</option>
                <option value="Vegetal em conflito com obra de infraestrutura urbana">Vegetal em conflito com obra de infraestrutura urbana</option>
                <option value="Vegetal em conflito com servi√ßo p√∫blico">Vegetal em conflito com servi√ßo p√∫blico</option>
                <option value="Vegetal em conflito com obras/servi√ßos de constru√ß√£o e reforma de edifica√ß√µes">Vegetal em conflito com obras/servi√ßos de constru√ß√£o e reforma de edifica√ß√µes</option>
                <option value="Vegetal em conflito com muro">Vegetal em conflito com muro</option>
                <option value="Vegetal em conflito com mobili√°rio urbano">Vegetal em conflito com mobili√°rio urbano</option>
                <option value="Vegetal em local inadequado">Vegetal em local inadequado</option>
                <option value="Vegetal em risco de queda">Vegetal em risco de queda</option>
                <option value="Vegetal com defici√™ncia nutricional">Vegetal com defici√™ncia nutricional</option>
                <option value="Vegetal em bom estado vegetativo">Vegetal em bom estado vegetativo</option>
                <option value="Vegetal sem necessidade de manejo (no momento da vistoria)">Vegetal sem necessidade de manejo (no momento da vistoria) Vegetal sem necessidade de manejo (no momento da vistoria)</option>
                <option value="Vegetal apresentando infesta√ß√£o por cupins">Vegetal apresentando infesta√ß√£o por cupins</option>
                <option value="Vegetal apresentando infesta√ß√£o por pulg√µes">Vegetal apresentando infesta√ß√£o por pulg√µes</option>
                <option value="Vegetal apresentando infesta√ß√£o por cochonilha">Vegetal apresentando infesta√ß√£o por cochonilha</option>
                <option value="Vegetal apresentando infesta√ß√£o por fumagina">Vegetal apresentando infesta√ß√£o por fumagina</option>
                <option value="Copa em conflito com a ilumina√ß√£o p√∫blica">Copa em conflito com a ilumina√ß√£o p√∫blica</option>
                <option value="Copa em conflito com edifica√ß√£o">Copa em conflito com edifica√ß√£o</option>
                <option value="Copa interferindo no tr√¢nsito de pedestres">Copa interferindo no tr√¢nsito de Pedestres</option>
                <option value="Copa interferindo no tr√¢nsito de Ve√≠culos">Copa interferindo no tr√¢nsito de Ve√≠culos</option>
                <option value="Copa com galhos secos">Copa com galhos secos</option>
                <option value="Copa com galhos doentes">Copa com galhos doentes</option>
                <option value="Copa com galhos pendentes em risco de queda">Copa com galhos pendentes em risco de queda</option>
                <option value="Copa desequilibrada">Copa desequilibrada</option>
                <option value="Copa descaracterizada">Copa descaracterizada</option>
                <option value="Copa em conflito com a rede el√©trica">Copa em conflito com a rede el√©trica</option>
                <option value="Copa incompat√≠vel com o espa√ßo dispon√≠vel">Copa incompat√≠vel com o espa√ßo dispon√≠vel</option>
                <option value="Copa infestada por erva passarinho">Copa infestada por erva passarinho</option>
                <option value="Ra√≠zes afloradas">Ra√≠zes afloradas</option>
                <option value="Ra√≠zes causando rachaduras na cal√ßada">Ra√≠zes causando rachaduras na cal√ßada</option>
                <option value="Ra√≠zes causando rachaduras no muro">Ra√≠zes causando rachaduras no muro</option>
                <option value="Ra√≠zes causando rachaduras na via p√∫blica">Ra√≠zes causando rachaduras na via p√∫blica</option>
                <option value="Ra√≠zes causando rachaduras na cal√ßada e no muro">Ra√≠zes causando rachaduras na cal√ßada e no muro</option>
                <option value="Ra√≠zes causando rachaduras na cal√ßada, no muro e na via p√∫blica">Ra√≠zes causando rachaduras na cal√ßada, no muro e na via p√∫blica</option>
                <option value="Ra√≠zes em conflito com a rede de esgoto">Ra√≠zes em conflito com a rede de esgoto</option>
                <option value="Ra√≠zes em conflito com a rede de √°gua">Ra√≠zes em conflito com a rede de √°gua</option>
                <option value="Ra√≠zes em conflito com a rede de drenagem pluvial">Ra√≠zes em conflito com a rede de drenagem pluvial</option>
                <option value="Ra√≠zes em conflito com o mobili√°rio urbano">Ra√≠zes em conflito com o mobili√°rio urbano</option>
                <option value="Outras situa√ß√µes">Outras situa√ß√µes</option>
            `;

            let indicacaoOptions = `
                <option value="">Selecione uma indica√ß√£o para adicionar...</option>
                <option value="Retirada com substitui√ß√£o">Retirada com substitui√ß√£o</option>
                <option value="Retirada sem substitui√ß√£o">Retirada sem substitui√ß√£o</option>
                <option value="Retirada - Termo de Compromisso Ambiental (TCA)">Retirada - Termo de Compromisso Ambiental (TCA)</option>
                <option value="Poda de caule/fuste">Poda de caule/fuste</option>
                <option value="Poda de condu√ß√£o">Poda de condu√ß√£o</option>
                <option value="Poda de corre√ß√£o">Poda de corre√ß√£o</option>
                <option value="Poda de conforma√ß√£o">Poda de conforma√ß√£o</option>
                <option value="Poda de compensa√ß√£o">Poda de compensa√ß√£o</option>
                <option value="Poda de limpeza">Poda de limpeza</option>
                <option value="Poda de adapta√ß√£o">Poda de adapta√ß√£o</option>
                <option value="Poda de adapta√ß√£o/levantamento de copa">Poda de adapta√ß√£o/levantamento de copa</option>
                <option value="Poda de adapta√ß√£o/rebaixamento de copa">Poda de adapta√ß√£o/rebaixamento de copa</option>
                <option value="Poda de prepara√ß√£o">Poda de prepara√ß√£o</option>
                <option value="Poda dr√°stica">Poda dr√°stica</option>
                <option value="Poda de ra√≠zes">Poda de ra√≠zes</option>
                <option value="Amplia√ß√£o de √°rea livre">Amplia√ß√£o de √°rea livre</option>
                <option value="Fechamento de √°rea livre">Fechamento de √°rea livre</option>
                <option value="Controle fitossanit√°rio">Controle fitossanit√°rio</option>
                <option value="Dendrocirurgia">Dendrocirurgia</option>
                <option value="outras">outras</option>
            `;


            arvoreDiv.innerHTML = `
                <h3>√Årvore </h3> <label for="especie-${arvoreCounter}">Esp√©cie:</label>
                <select id="especie-${arvoreCounter}" required>${especiesOptions}</select>

                <label for="quantidade-${arvoreCounter}">Quantidade:</label>
                <input type="number" id="quantidade-${arvoreCounter}" min="1" value="1" required />

                <label for="posicao-${arvoreCounter}">Posi√ß√£o:</label>
                <select id="posicao-${arvoreCounter}" required>${posicoesOptions}</select>

                <div class="campo-condicional-altura-cap">
                    <label for="altura-${arvoreCounter}">Altura (m):</label>
                    <input type="number" id="altura-${arvoreCounter}" step="0.1" />

                    <label for="cap-${arvoreCounter}">CAP (cm) - Circunfer√™ncia √† Altura do Peito:</label>
                    <input type="number" id="cap-${arvoreCounter}" step="0.1" />
                </div>

                <div class="campo-condicional-plantio"> <!-- NOVO: Campos de plantio por √°rvore -->
                    <h4>Informa√ß√µes para Plantio desta √Årvore:</h4>
                    <label for="aberturaAreaLivre-${arvoreCounter}">Abertura de √Årea Livre:</label>
                    <select id="aberturaAreaLivre-${arvoreCounter}">
                        <option value="">Selecione uma op√ß√£o</option>
                        <option value="√Årea pavimentada">√Årea pavimentada</option>
                        <option value="√Årea n√£o pavimentada">√Årea n√£o pavimentada</option>
                        <option value="√Årea livre aberta">√Årea livre aberta</option> <!-- NOVA OP√á√ÉO AQUI -->
                    </select>

                    <label for="larguraCalcada-${arvoreCounter}">Largura da Cal√ßada (m):</label>
                    <input type="number" id="larguraCalcada-${arvoreCounter}" step="0.1" min="0" placeholder="Ex: 1.5" />
                </div>

                <div class="campo-condicional-diagnostico">
                    <label for="selectDiagnostico-${arvoreCounter}">Diagn√≥stico:</label>
                    <div class="add-section">
                        <select id="selectDiagnostico-${arvoreCounter}">${diagnosticoOptions}</select>
                        <button type="button" class="btnAddDiagnosticoTree" data-tree-id="${currentTreeId}">Adicionar</button>
                    </div>
                    <div id="diagnosesSelecionados-${currentTreeId}" class="selected-tags-container">
                        </div>
                </div>

                <div class="campo-condicional-indicacao">
                    <label for="selectIndicacao-${arvoreCounter}">Indica√ß√£o:</label>
                    <div class="add-section">
                        <select id="selectIndicacao-${arvoreCounter}">${indicacaoOptions}</select>
                        <button type="button" class="btnAddIndicacaoTree" data-tree-id="${currentTreeId}">Adicionar</button>
                    </div>
                    <div id="indicationsSelecionados-${currentTreeId}" class="selected-tags-container">
                        </div>
                </div>

                <label for="obsArvore-${arvoreCounter}">Obs:</label>
                <textarea id="obsArvore-${arvoreCounter}" rows="3"></textarea>
                <button type="button" onclick="transcreverVozParaTexto('obsArvore-${arvoreCounter}')" class="voice-button">üé§ Falar e transcrever</button>
                <button type="button" class="clear-obs-arvore-button" data-target-id="obsArvore-${arvoreCounter}">Limpar Obs</button> <!-- NOVO BOT√ÉO AQUI -->

                <button type="button" class="remove-arvore" data-arvore-id="${currentTreeId}">Remover √Årvore</button>
                <hr style="margin-top: 15px; margin-bottom: 15px; border-top: 1px dashed #ccc;">
            `;
            container.appendChild(arvoreDiv);

            // Adiciona o novo objeto de √°rvore ao array global
            arvoresData.push({
                id: currentTreeId,
                especie: "", // Inicializa com valores vazios
                quantidade: 1,
                posicao: "",
                altura: null,
                cap: null,
                diagnoses: [],
                indications: [],
                obsArvore: "",
                aberturaAreaLivre: "", // Adicionado para plantio
                larguraCalcada: null // Adicionado para plantio
            });

            // Adiciona event listener para o bot√£o remover
            arvoreDiv.querySelector(`.remove-arvore`).addEventListener('click', (event) => {
                const idToRemove = event.target.dataset.arvoreId;
                document.getElementById(idToRemove).remove();
                arvoresData = arvoresData.filter(arvore => arvore.id !== idToRemove);
                updateArvoreTitles();
                applyTreeFieldVisibility();
            });

            // Adiciona event listeners para os bot√µes de adicionar diagn√≥stico e indica√ß√£o
            arvoreDiv.querySelector(`.btnAddDiagnosticoTree`).addEventListener('click', (event) => {
                const treeId = event.target.dataset.treeId;
                addItemToList(`selectDiagnostico-${arvoreCounter}`, treeId, 'diagnoses');
            });
            arvoreDiv.querySelector(`.btnAddIndicacaoTree`).addEventListener('click', (event) => {
                const treeId = event.target.dataset.treeId;
                addItemToList(`selectIndicacao-${arvoreCounter}`, treeId, 'indications');
            });

            // Adiciona event listeners para os campos que afetam arvoresData (e a sugest√£o de OS)
            arvoreDiv.querySelector(`#especie-${arvoreCounter}`).addEventListener('change', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.especie = event.target.value;
            });
            arvoreDiv.querySelector(`#quantidade-${arvoreCounter}`).addEventListener('input', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.quantidade = parseInt(event.target.value) || 0;
            });
            arvoreDiv.querySelector(`#posicao-${arvoreCounter}`).addEventListener('change', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.posicao = event.target.value;
                // NOVO: Chama a fun√ß√£o de visibilidade da largura da cal√ßada ao mudar a posi√ß√£o
                updateLarguraCalcadaVisibility(currentTreeId);
            });
            arvoreDiv.querySelector(`#altura-${arvoreCounter}`).addEventListener('input', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.altura = parseFloat(event.target.value) || null;
            });
            arvoreDiv.querySelector(`#cap-${arvoreCounter}`).addEventListener('input', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.cap = parseFloat(event.target.value) || null;
            });
            arvoreDiv.querySelector(`#obsArvore-${arvoreCounter}`).addEventListener('input', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.obsArvore = event.target.value;
            });
            // NOVO: Event listeners para os campos de plantio por √°rvore
            arvoreDiv.querySelector(`#aberturaAreaLivre-${arvoreCounter}`).addEventListener('change', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.aberturaAreaLivre = event.target.value;
                // NOVO: Chama a fun√ß√£o de visibilidade da largura da cal√ßada ao mudar a abertura de √°rea livre
                updateLarguraCalcadaVisibility(currentTreeId);
            });
            arvoreDiv.querySelector(`#larguraCalcada-${arvoreCounter}`).addEventListener('input', (event) => {
                const arvore = arvoresData.find(a => a.id === currentTreeId);
                if (arvore) arvore.larguraCalcada = parseFloat(event.target.value) || null;
            });


            // Adiciona event listener para o novo bot√£o de limpar Obs (da √°rvore espec√≠fica)
            arvoreDiv.querySelector('.clear-obs-arvore-button').addEventListener('click', (event) => {
                const targetId = event.target.dataset.targetId; // Pega o ID da textarea de obs
                const field = document.getElementById(targetId);
                if (field) {
                    field.value = '';
                    // N√£o usar alert aqui para n√£o interromper o fluxo
                    console.log('Campo de observa√ß√£o da √°rvore limpo!');
                }
            });


            updateArvoreTitles();
            applyTreeFieldVisibility();
            // NOVO: Chama a fun√ß√£o de visibilidade da largura da cal√ßada para a nova √°rvore
            updateLarguraCalcadaVisibility(currentTreeId);
        }

        // Fun√ß√£o para ajustar a visibilidade dos campos dentro de cada bloco de √°rvore E dos novos campos de plantio
        function applyTreeFieldVisibility() {
            const selectServico = document.getElementById('servico');
            const isPlantio = (selectServico.value === 'Plantio');

            document.querySelectorAll('.arvore-item').forEach(arvoreItem => {
                const treeId = arvoreItem.id.split('-')[1];

                const alturaCapFields = arvoreItem.querySelector('.campo-condicional-altura-cap');
                const diagnosticoField = arvoreItem.querySelector('.campo-condicional-diagnostico');
                const indicacaoField = arvoreItem.querySelector('.campo-condicional-indicacao');
                const plantioPerTreeFields = arvoreItem.querySelector('.campo-condicional-plantio');


                if (isPlantio) {
                    // Oculta campos de altura/CAP, diagn√≥stico e indica√ß√£o
                    if (alturaCapFields) alturaCapFields.classList.add('campo-plantio-oculto');
                    if (diagnosticoField) diagnosticoField.classList.add('campo-plantio-oculto');
                    if (indicacaoField) indicacaoField.classList.add('campo-plantio-oculto');

                    // Exibe campos de plantio por √°rvore
                    if (plantioPerTreeFields) plantioPerTreeFields.style.display = 'block';

                    // Remove o required de altura para plantio
                    arvoreItem.querySelector(`#altura-${treeId}`).removeAttribute('required');
                    arvoreItem.querySelector(`#cap-${treeId}`).removeAttribute('required');

                    // Adiciona required para Abertura de √Årea Livre
                    arvoreItem.querySelector(`#aberturaAreaLivre-${treeId}`).setAttribute('required', 'required');
                    // A largura da cal√ßada ser√° tratada por updateLarguraCalcadaVisibility

                } else {
                    // Exibe campos de altura/CAP, diagn√≥stico e indica√ß√£o
                    if (alturaCapFields) alturaCapFields.classList.remove('campo-plantio-oculto');
                    if (diagnosticoField) diagnosticoField.classList.remove('campo-plantio-oculto');
                    if (indicacaoField) indicacaoField.classList.remove('campo-plantio-oculto');

                    // Oculta campos de plantio por √°rvore
                    if (plantioPerTreeFields) plantioPerTreeFields.style.display = 'none';

                    // Adiciona required de altura para n√£o-plantio
                    arvoreItem.querySelector(`#altura-${treeId}`).setAttribute('required', 'required');
                    // CAP continua opcional, ent√£o n√£o adiciona required

                    // Remove required de campos de plantio
                    arvoreItem.querySelector(`#aberturaAreaLivre-${treeId}`).removeAttribute('required');
                    arvoreItem.querySelector(`#larguraCalcada-${treeId}`).removeAttribute('required');
                    // Limpa os valores dos campos de plantio quando ocultos
                    arvoreItem.querySelector(`#aberturaAreaLivre-${treeId}`).value = '';
                    arvoreItem.querySelector(`#larguraCalcada-${treeId}`).value = '';
                }
                // NOVO: Chama a fun√ß√£o de visibilidade da largura da cal√ßada para cada √°rvore
                updateLarguraCalcadaVisibility(arvoreItem.id);
            });
        }

        // --- L√ìGICA DO MODAL DE DESENHO ---
        function setupDrawingCanvas() {
            drawingCanvas = document.getElementById('drawingCanvas');
            drawingCtx = drawingCanvas.getContext('2d');

            // Configura√ß√µes iniciais do pincel
            drawingCtx.lineWidth = document.getElementById('brushSize').value;
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = document.getElementById('brushColor').value;

            // Event listeners para as ferramentas
            document.querySelectorAll('.tool-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentTool = button.dataset.tool;
                    console.log("Ferramenta selecionada:", currentTool);
                });
            });

            // Eventos de desenho para mouse
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);

            // Eventos de desenho para toque
            drawingCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Previne o scroll da p√°gina
                startDrawing(e.touches[0]);
            });
            drawingCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Previne o scroll da p√°gina
                draw(e.touches[0]);
            });
            drawingCanvas.addEventListener('touchend', stopDrawing);
            drawingCanvas.addEventListener('touchcancel', stopDrawing);

            // Event listeners para controles do desenho
            document.getElementById('brushColor').addEventListener('input', (e) => {
                drawingCtx.strokeStyle = e.target.value;
            });
            document.getElementById('brushSize').addEventListener('input', (e) => {
                drawingCtx.lineWidth = e.target.value;
            });
            document.getElementById('clearCanvasBtn').addEventListener('click', clearDrawingCanvas);
            document.getElementById('saveDrawingBtn').addEventListener('click', saveDrawing);
            document.getElementById('cancelDrawingBtn').addEventListener('click', cancelDrawing);

            // Fechar modal clicando fora
            document.getElementById('drawingModalOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'drawingModalOverlay') {
                    cancelDrawing();
                }
            });
        }

        function getCanvasCoordinates(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            let x, y;
            if (e.clientX !== undefined) { // Mouse or Touch event
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            } else { // Fallback, though clientX/Y should be present
                x = e.offsetX;
                y = e.offsetY;
            }
            return { x, y };
        }

        function startDrawing(e) {
            isDrawing = true;
            const { x, y } = getCanvasCoordinates(e);
            startX = x;
            startY = y;
            lastX = x;
            lastY = y;

            if (currentTool === 'line') {
                // Para linhas, come√ßamos um novo caminho de pontos
                drawnShapes.push({
                    type: 'line',
                    points: [{ x: startX, y: startY }],
                    color: drawingCtx.strokeStyle,
                    lineWidth: drawingCtx.lineWidth
                });
            }
            redrawCanvas(); // Redraw to clear any temporary previous drawing
        }

        function draw(e) {
            if (!isDrawing) return;

            const { x, y } = getCanvasCoordinates(e);
            const currentColor = drawingCtx.strokeStyle;
            const currentWidth = drawingCtx.lineWidth;

            redrawCanvas(); // Clear and redraw permanent shapes

            // Draw temporary shape
            drawingCtx.beginPath();
            drawingCtx.strokeStyle = currentColor;
            drawingCtx.lineWidth = currentWidth;

            if (currentTool === 'line') {
                const currentLine = drawnShapes[drawnShapes.length - 1];
                if (currentLine && currentLine.type === 'line') {
                    currentLine.points.push({ x, y });
                    drawShape(currentLine); // Redraw the current evolving line
                }
            } else if (currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                drawingCtx.arc(startX, startY, radius, 0, 2 * Math.PI);
                drawingCtx.stroke();
            } else if (currentTool === 'arrow') {
                drawArrow(drawingCtx, startX, startY, x, y, currentColor, currentWidth);
            }
            lastX = x;
            lastY = y;
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            isDrawing = false;

            const { x, y } = getCanvasCoordinates(e);
            const currentColor = drawingCtx.strokeStyle;
            const currentWidth = drawingCtx.lineWidth;

            if (currentTool === 'line') {
                // Line points are already added in draw()
            } else if (currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                drawnShapes.push({
                    type: 'circle',
                    centerX: startX,
                    centerY: startY,
                    radius: radius,
                    color: currentColor,
                    lineWidth: currentWidth
                });
            } else if (currentTool === 'arrow') {
                drawnShapes.push({
                    type: 'arrow',
                    startX: startX,
                    startY: startY,
                    endX: x,
                    endY: y,
                    color: currentColor,
                    lineWidth: currentWidth
                });
            }
            redrawCanvas(); // Final redraw with the new permanent shape
        }

        function redrawCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            if (drawingCanvas.originalImage) {
                drawingCtx.drawImage(drawingCanvas.originalImage, 0, 0, drawingCanvas.width, drawingCanvas.height);
            }

            drawnShapes.forEach(shape => {
                drawShape(shape);
            });
        }

        function drawShape(shape) {
            drawingCtx.strokeStyle = shape.color;
            drawingCtx.lineWidth = shape.lineWidth;
            drawingCtx.beginPath();

            if (shape.type === 'line') {
                if (shape.points.length > 0) {
                    drawingCtx.moveTo(shape.points[0].x, shape.points[0].y);
                    for (let i = 1; i < shape.points.length; i++) {
                        drawingCtx.lineTo(shape.points[i].x, shape.points[i].y);
                    }
                }
            } else if (shape.type === 'circle') {
                drawingCtx.arc(shape.centerX, shape.centerY, shape.radius, 0, 2 * Math.PI);
            } else if (shape.type === 'arrow') {
                drawArrow(drawingCtx, shape.startX, shape.startY, shape.endX, shape.endY, shape.color, shape.lineWidth);
                return; // drawArrow handles its own stroke
            }
            drawingCtx.stroke();
        }

        function drawArrow(ctx, x1, y1, x2, y2, color, lineWidth) {
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            // Draw arrowhead
            const headlen = 10; // length of head in pixels
            const angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }


        function clearDrawingCanvas() {
            drawnShapes = []; // Clear all drawn shapes
            redrawCanvas(); // Redraw to show only the original image
        }

        async function openDrawingModal(photoIndex) {
            currentEditingPhotoIndex = photoIndex;
            const modalOverlay = document.getElementById('drawingModalOverlay');
            modalOverlay.style.display = 'flex';
            drawnShapes = []; // Clear shapes from previous edits

            const photoInputId = `foto${photoIndex + 1}`;
            const fileInput = document.getElementById(photoInputId);
            let imageDataUrl = null;

            // Prioriza a imagem j√° editada, depois a do preview, depois a do input
            if (editedPhotoDataUrls[photoIndex]) {
                imageDataUrl = editedPhotoDataUrls[photoIndex];
            } else {
                const previewImg = document.querySelector(`#previewFotos img[data-input-id="${photoInputId}"]`);
                if (previewImg && previewImg.src) {
                    imageDataUrl = previewImg.src;
                } else if (fileInput && fileInput.files && fileInput.files[0]) {
                    imageDataUrl = await compressImage(fileInput.files[0]);
                }
            }

            if (imageDataUrl) {
                const img = new Image();
                img.src = imageDataUrl;
                img.onload = () => {
                    // Redimensiona o canvas para a imagem ou um tamanho m√°ximo
                    const maxWidth = 600; // Max width for drawing canvas
                    const maxHeight = 450; // Max height for drawing canvas
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }

                    drawingCanvas.width = width;
                    drawingCanvas.height = height;
                    drawingCanvas.originalImage = img; // Armazena a imagem original no canvas
                    redrawCanvas(); // Desenha a imagem original
                };
                img.onerror = () => {
                    alert("Erro ao carregar imagem para edi√ß√£o.");
                    cancelDrawing();
                };
            } else {
                alert("Nenhuma imagem selecionada para editar.");
                cancelDrawing();
            }
        }

        function saveDrawing() {
            if (currentEditingPhotoIndex !== -1) {
                const dataUrl = drawingCanvas.toDataURL('image/png'); // Salva como PNG para manter transpar√™ncia do desenho
                editedPhotoDataUrls[currentEditingPhotoIndex] = dataUrl;

                // Atualiza a pr√©-visualiza√ß√£o no formul√°rio com a imagem editada
                const photoInputId = `foto${currentEditingPhotoIndex + 1}`;
                const previewImgElement = document.querySelector(`#previewFotos img[data-input-id="${photoInputId}"]`);
                if (previewImgElement) {
                    previewImgElement.src = dataUrl;
                }
            }
            closeDrawingModal();
        }

        function cancelDrawing() {
            closeDrawingModal();
        }

        function closeDrawingModal() {
            document.getElementById('drawingModalOverlay').style.display = 'none';
            currentEditingPhotoIndex = -1;
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height); // Limpa o canvas
            drawingCanvas.originalImage = null; // Limpa a refer√™ncia da imagem original
            drawnShapes = []; // Garante que as formas sejam limpas ao fechar o modal
        }
        // --- FIM DA L√ìGICA DO MODAL DE DESENHO ---


        // Event Listener para preencher os previews das fotos
        document.addEventListener('DOMContentLoaded', async () => {
            const previewFotosDiv = document.getElementById('previewFotos');
            const inputFotos = ['foto1', 'foto2', 'foto3', 'foto4'];

            // Setup do canvas de desenho
            setupDrawingCanvas();

            inputFotos.forEach((id, index) => {
                const inputElement = document.getElementById(id);
                const descriptionElement = document.getElementById(`descricao${id.charAt(0).toUpperCase() + id.slice(1)}`); // e.g., descricaoFoto1
                
                // Carrega descri√ß√µes salvas (se houver)
                descriptionElement.value = photoDescriptions[index];

                // Event listener para atualizar a descri√ß√£o
                descriptionElement.addEventListener('input', (event) => {
                    photoDescriptions[index] = event.target.value;
                });

                if (inputElement) {
                    inputElement.addEventListener('change', async function(event) {
                        const existingPhotoItem = previewFotosDiv.querySelector(`.photo-item[data-input-id="${id}"]`);
                        if (existingPhotoItem) {
                            existingPhotoItem.remove();
                        }
                        // Limpa qualquer edi√ß√£o anterior para esta foto
                        editedPhotoDataUrls[index] = null;

                        if (event.target.files && event.target.files[0]) {
                            const file = event.target.files[0];
                            const compressedDataUrl = await compressImage(file);

                            const photoItemDiv = document.createElement('div');
                            photoItemDiv.classList.add('photo-item');
                            photoItemDiv.dataset.inputId = id;

                            const img = document.createElement('img');
                            img.src = compressedDataUrl;
                            img.dataset.inputId = id; // Para refer√™ncia no PDF

                            const actionsDiv = document.createElement('div');
                            actionsDiv.classList.add('photo-actions');

                            const editButton = document.createElement('button');
                            editButton.textContent = 'Editar Desenho';
                            editButton.type = 'button';
                            editButton.addEventListener('click', () => openDrawingModal(index));

                            const clearButton = document.createElement('button');
                            clearButton.textContent = 'Limpar Foto';
                            clearButton.type = 'button';
                            clearButton.style.backgroundColor = '#dc3545'; // Cor para limpar
                            clearButton.addEventListener('click', () => {
                                // Limpa o input file
                                inputElement.value = '';
                                // Remove o item de pr√©-visualiza√ß√£o
                                photoItemDiv.remove();
                                // Limpa a descri√ß√£o e a imagem editada
                                descriptionElement.value = '';
                                photoDescriptions[index] = '';
                                editedPhotoDataUrls[index] = null;
                            });

                            actionsDiv.appendChild(editButton);
                            actionsDiv.appendChild(clearButton);

                            photoItemDiv.appendChild(img);
                            photoItemDiv.appendChild(actionsDiv); // Adiciona os bot√µes ao item
                            previewFotosDiv.appendChild(photoItemDiv);
                        }
                    });
                }
            });

            const selectServico = document.getElementById('servico');
            const arvoresContainer = document.getElementById('arvoresContainer');
            const btnAddArvore = document.getElementById('btnAddArvore');


            // Fun√ß√µes para controlar a visibilidade
            function setTreeSectionVisibility(isVisible) {
                arvoresContainer.style.display = isVisible ? 'block' : 'none';
                btnAddArvore.style.display = isVisible ? 'block' : 'none';
                if (!isVisible) {
                    arvoresData = [];
                    arvoresContainer.innerHTML = '';
                    arvoreCounter = 0;
                } else if (arvoresData.length === 0) {
                    addArvoreFields();
                }
                updateArvoreTitles();
                applyTreeFieldVisibility(); // Reaplicar visibilidade espec√≠fica dos campos
            }

            selectServico.addEventListener('change', () => {
                setTreeSectionVisibility(selectServico.value !== '');
            });


            // Chama no carregamento da p√°gina para definir o estado inicial
            setTreeSectionVisibility(selectServico.value !== '');
            // O `Plantio` ser√° tratado dentro de `applyTreeFieldVisibility`

            // --- CHAMADA INICIAL PARA PREENCHER O N√öMERO DO RELAT√ìRIO AO CARREGAR A P√ÅGINA ---
            displayCurrentReportNumber();
        });

        // Event listener para o bot√£o "Adicionar √Årvore"
        document.getElementById('btnAddArvore').addEventListener('click', addArvoreFields);


        // Fun√ß√£o principal para gerar o PDF
        async function gerarPDF() {
            console.log("DEBUG: Fun√ß√£o gerarPDF() iniciada. Isso s√≥ deve acontecer ao clicar em 'Gerar PDF'.");
            const doc = new jsPDF();
            // A fun√ß√£o get foi ajustada para os novos IDs
            const get = id => document.getElementById(id)?.value || "";

            const numeroRelatorio = document.getElementById("numero").value;
            const responsavelTecnico = get("tecnico");
            let dataFormatada = "____/____/____";
            const dataRaw = get("dataFinal");
            if (dataRaw && dataRaw.includes("-")) {
                const partes = dataRaw.split("-");
                if (partes.length === 3) {
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }

            // --- Configura√ß√µes de Margem e Cor de Linha ---
            const marginX = 20;
            const marginYTop = 15;
            const marginYBottom = 30;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            doc.setDrawColor(150, 150, 150);

            // --- Cabe√ßalho do Relat√≥rio ---
            doc.setFontSize(18);
            doc.text("RELAT√ìRIO T√âCNICO", pageWidth / 2, marginYTop, { align: "center" });

            let y = marginYTop + 5;

            // --- Linha Horizontal Acima da Tabela de Dados Principais ---
            doc.line(marginX, y, pageWidth - marginX, y);
            y += 5;

            // --- Tabela de Dados Principais ---
            const servicoSelecionado = document.getElementById("servico").value;

            // Fun√ß√£o para adicionar o rodap√© fixo
            const addFooter = (doc, responsavelTecnico, dataFormatada) => {
                const lineY = pageHeight - 20;
                const textY = pageHeight - 15;

                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');

                doc.text(`Respons√°vel T√©cnico: ${responsavelTecnico}`, marginX, textY);
                doc.text(`Data de Emiss√£o: ${dataFormatada}`, pageWidth - marginX, textY, { align: "right" });

                doc.setDrawColor(150, 150, 150);
                doc.line(marginX, lineY, pageWidth - marginX, lineY);
            };

            const mainTableBody = [
                ['Ref.:', `${get("tipoReferencia")}: ${get("numeroReferencia")}`],
                ['Relat√≥rio N¬∫:', numeroRelatorio],
                ['Servi√ßo:', servicoSelecionado],
                ['Bairro:', get("bairro")],
                ['Endere√ßo:', get("endereco")]
            ];

            doc.autoTable({
                startY: y,
                body: mainTableBody,
                theme: 'plain',
                styles: {
                    fontSize: 11,
                    cellPadding: 0,
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: {
                        cellWidth: 25, // Reduzido o cellWidth da primeira coluna
                        fontStyle: 'bold',
                        textColor: [46, 125, 50],
                        halign: 'left',
                        cellPadding: { left: 0, right: 0, top: 0, bottom: 0 }
                    },
                    1: {
                        cellWidth: 'auto', // Permite que a segunda coluna ocupe o restante do espa√ßo
                        halign: 'left',
                        cellPadding: { left: 0, right: 0, top: 0, bottom: 0 }
                    }
                },
                margin: { left: marginX, right: marginX },
                didDrawPage: (data) => {
                    addFooter(doc, responsavelTecnico, dataFormatada);
                }
            });

            y = doc.autoTable.previous.finalY + 10;

            // Linha horizontal inferior da tabela principal (mantida)
            doc.line(marginX, doc.autoTable.previous.finalY + 5, pageWidth - marginX, doc.autoTable.previous.finalY + 5);
            y = doc.autoTable.previous.finalY + 8;

            // --- Coleta e adi√ß√£o dos dados das √Årvores ao PDF ---
            const arvoresParaPdf = [];
            arvoresData.forEach((arvoreDataEntry, index) => {
                const isPlantio = (servicoSelecionado === 'Plantio');
                
                // Valida√ß√£o para determinar se a √°rvore deve ser inclu√≠da no PDF
                let shouldIncludeTree = false;
                if (isPlantio) {
                    // Para plantio, os campos essenciais s√£o especie, quantidade, posicao e aberturaAreaLivre
                    if (arvoreDataEntry.especie && arvoreDataEntry.quantidade !== "" && arvoreDataEntry.posicao && arvoreDataEntry.aberturaAreaLivre) {
                        shouldIncludeTree = true;
                    }
                } else {
                    // Para outros servi√ßos, especie, quantidade, posicao e altura devem estar preenchidos
                    if (arvoreDataEntry.especie && arvoreDataEntry.quantidade !== "" && arvoreDataEntry.posicao && arvoreDataEntry.altura !== "") {
                        shouldIncludeTree = true;
                    }
                }

                if (shouldIncludeTree) {
                    arvoresParaPdf.push({
                        numero: index + 1,
                        especie: arvoreDataEntry.especie,
                        quantidade: arvoreDataEntry.quantidade,
                        posicao: arvoreDataEntry.posicao,
                        altura: isPlantio ? "N/A" : (arvoreDataEntry.altura || "N/A"), // Fallback if empty
                        cap: isPlantio ? "N/A" : (arvoreDataEntry.cap || "N/A"), // Fallback if empty
                        diagnoses: isPlantio ? [] : arvoreDataEntry.diagnoses,
                        indications: isPlantio ? [] : arvoreDataEntry.indications,
                        obsArvore: arvoreDataEntry.obsArvore,
                        aberturaAreaLivre: arvoreDataEntry.aberturaAreaLivre, // NOVO: para PDF
                        larguraCalcada: arvoreDataEntry.larguraCalcada // NOVO: para PDF
                    });
                }
            });

            if (arvoresParaPdf.length > 0) {
                y += 7;
                if (y + 20 > pageHeight - marginYBottom) {
                    doc.addPage();
                    y = marginYTop;
                    addFooter(doc, responsavelTecnico, dataFormatada);
                }
                doc.setFont('helvetica', 'bold');
                doc.setTextColor("#2e7d32");
                doc.setFontSize(12);
                // T√≠tulo condicional da se√ß√£o de √°rvores
                doc.text(servicoSelecionado === 'Plantio' ? "√Årvore(s) indicada(s) para plantio:" : "Informa√ß√µes das √Årvores:", marginX, y);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                y += 5;

                const tableHead = (servicoSelecionado === 'Plantio') ?
                                    [['√Årvore', 'Esp√©cie', 'Qtd.', 'Posi√ß√£o']] :
                                    [['√Årvore', 'Esp√©cie', 'Qtd.', 'Posi√ß√£o', 'Altura (m)', 'CAP (cm)']];

                const tableRows = arvoresParaPdf.map(arvore => {
                    if (servicoSelecionado === 'Plantio') {
                        return [
                            `√Årvore ${arvore.numero}`,
                            arvore.especie,
                            arvore.quantidade,
                            arvore.posicao
                        ];
                    } else {
                        return [
                            `√Årvore ${arvore.numero}`,
                            arvore.especie,
                            arvore.quantidade,
                            arvore.posicao,
                            arvore.altura, // Already includes "N/A" if empty
                            arvore.cap // Already includes "N/A" if empty
                        ];
                    }
                });

                doc.autoTable({
                    startY: y,
                    head: tableHead,
                    body: tableRows,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 2 },
                    headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255], fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 20 },
                        1: { cellWidth: 'auto' },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 25 },
                        4: { cellWidth: 20 },
                        5: { cellWidth: 20 }
                    },
                    margin: { left: marginX, right: marginX },
                    didDrawPage: (data) => {
                        addFooter(doc, responsavelTecnico, dataFormatada);
                    }
                });
                y = doc.autoTable.previous.finalY + 3;

                // Loop para detalhes de cada √°rvore
                for (const arvore of arvoresParaPdf) {
                    y += 3; 
                    let estimatedDetailHeight = 0;

                    // Calcula a altura estimada para os detalhes da √°rvore para verificar quebra de p√°gina
                    if (servicoSelecionado === 'Plantio') {
                        // NOVO: Campos de plantio por √°rvore
                        if (arvore.aberturaAreaLivre) estimatedDetailHeight += 8; // Linha para Abertura de √Årea Livre
                        
                        // NOVO: Usa a mesma l√≥gica de visibilidade para estimar a altura
                        const shouldEstimateLarguraCalcada = (arvore.aberturaAreaLivre === '√Årea pavimentada' || arvore.posicao === 'Cal√ßada');
                        
                        if (shouldEstimateLarguraCalcada) estimatedDetailHeight += 8; // Linha para Largura da Cal√ßada
                        estimatedDetailHeight += 10; // Espa√ßo extra
                    } else { // Diagn√≥stico e Indica√ß√£o para outros servi√ßos
                        if (arvore.diagnoses && arvore.diagnoses.length > 0) estimatedDetailHeight += arvore.diagnoses.length * 4;
                        if (arvore.indications && arvore.indications.length > 0) estimatedDetailHeight += arvore.indications.length * 4;
                        estimatedDetailHeight += 10; // Para os t√≠tulos de Diagn√≥stico/Indica√ß√£o
                    }

                    if (arvore.obsArvore.trim() !== "") {
                        const obsSplitted = doc.splitTextToSize(arvore.obsArvore, pageWidth - (2 * marginX) - 10);
                        estimatedDetailHeight += obsSplitted.length * 4 + 5; // Altura da obs + t√≠tulo
                    }

                    estimatedDetailHeight += 15; // Espa√ßo extra

                    if (y + estimatedDetailHeight > pageHeight - marginYBottom) {
                        doc.addPage();
                        y = marginYTop;
                        addFooter(doc, responsavelTecnico, dataFormatada);
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor("#2e7d32");
                    doc.setFontSize(11);
                    doc.text(`√Årvore ${arvore.numero} - Detalhes:`, marginX, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9); // Voltando para tamanho normal de texto para os detalhes
                    y += 5;

                    // ADICIONA CAMPOS DE PLANTIO DENTRO DOS DETALHES DA √ÅRVORE (SE FOR PLANTIO)
                    if (servicoSelecionado === 'Plantio') {
                        // NOVO: Usa os dados da √°rvore atual
                        if (arvore.aberturaAreaLivre) {
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor("#2e7d32");
                            doc.text("Abertura de √Årea Livre:", marginX + 5, y);
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.text(arvore.aberturaAreaLivre, marginX + 10, y + 4);
                            y += 8;
                        }
                        // NOVO: Usa os dados da √°rvore atual e a nova l√≥gica de visibilidade
                        const shouldDisplayLarguraCalcadaInPdf = (arvore.aberturaAreaLivre === '√Årea pavimentada' || arvore.posicao === 'Cal√ßada');

                        if (shouldDisplayLarguraCalcadaInPdf) {
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor("#2e7d32");
                            doc.text("Largura da Cal√ßada:", marginX + 5, y);
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            // Exibe o valor ou "N/A" se estiver vazio/nulo
                            doc.text(`${arvore.larguraCalcada !== null && arvore.larguraCalcada !== "" ? arvore.larguraCalcada + ' m' : 'N/A'}`, marginX + 10, y + 4);
                            y += 8;
                        }
                        y += 3; // Espa√ßamento ap√≥s os campos de plantio, se existirem
                    } else { // ADICIONA DIAGN√ìSTICO E INDICA√á√ÉO PARA OUTROS SERVI√áOS
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor("#2e7d32");
                        doc.text("Diagn√≥stico:", marginX + 5, y);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                        y += 4;
                        if (arvore.diagnoses && arvore.diagnoses.length > 0) {
                            for (const diag of arvore.diagnoses) {
                                const line = `- ${diag}`;
                                const diagSplitted = doc.splitTextToSize(line, pageWidth - (2 * marginX) - 10);
                                doc.text(diagSplitted, marginX + 10, y);
                                y += diagSplitted.length * (doc.getLineHeight() / doc.internal.scaleFactor);
                            }
                        } else {
                            doc.text("Nenhum diagn√≥stico selecionado.", marginX + 10, y);
                            y += 4;
                        }
                        y += 3;

                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor("#2e7d32");
                        doc.text("Indica√ß√£o:", marginX + 5, y);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                        y += 4;
                        if (arvore.indications && arvore.indications.length > 0) {
                            for (const indic of arvore.indications) {
                                const line = `- ${indic}`;
                                const indicSplitted = doc.splitTextToSize(line, pageWidth - (2 * marginX) - 10);
                                doc.text(indicSplitted, marginX + 10, y);
                                y += indicSplitted.length * (doc.getLineHeight() / doc.internal.scaleFactor);
                            }
                        } else {
                            doc.text("Nenhuma indica√ß√£o selecionada.", marginX + 10, y);
                            y += 4;
                        }
                        y += 3;
                    }

                    const obsArvoreContent = arvore.obsArvore.trim();
                    if (obsArvoreContent !== "") {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor("#2e7d32");
                        doc.text("Obs:", marginX + 5, y);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                        y += 4;
                        // Define obsSplitted aqui, antes de us√°-lo
                        const obsSplitted = doc.splitTextToSize(obsArvoreContent, pageWidth - (2 * marginX) - 10);
                        doc.text(obsSplitted, marginX + 10, y, { align: "justify", maxWidth: pageWidth - (2 * marginX) - 10 });
                        y += obsSplitted.length * (doc.getLineHeight() / doc.internal.scaleFactor);
                        y += 3;
                    }
                    y += 5;
                }
            } else {
                y += 7;
                if (y + 20 > pageHeight - marginYBottom) {
                    doc.addPage();
                    y = marginYTop;
                    addFooter(doc, responsavelTecnico, dataFormatada);
                }
                doc.setFont('helvetica', 'bold');
                doc.setTextColor("#2e7d32");
                doc.setFontSize(12);
                // T√≠tulo condicional da se√ß√£o de √°rvores
                doc.text(servicoSelecionado === 'Plantio' ? "√Årvore(s) indicada(s) para plantio:" : "Informa√ß√µes das √Årvores:", marginX, y);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                y += 5;
                doc.setFontSize(10);
                doc.text("Nenhuma √°rvore cadastrada.", marginX, y);
                y += 10;
            }

            doc.line(marginX, y - 2, pageWidth - marginX, y - 2);
            y += 5;

            // --- Localiza√ß√£o (Mapa) ---
            if (mapa && document.getElementById('mapaInterativo') && latGlobal && lngGlobal) {
                console.log("üì∏ Tentando capturar o mapa interativo com html2canvas...");
                const mapContainer = document.getElementById('mapaInterativo');
                const maxMapHeightPdf = 70; // Altura m√°xima desejada para o mapa no PDF

                try {
                    mapa.invalidateSize();

                    const canvas = await html2canvas(mapContainer, {
                        useCORS: true,
                        allowTaint: true
                    });
                    const mapaDataUrl = canvas.toDataURL('image/png');

                    // Calcula a altura da imagem proporcionalmente √† largura dispon√≠vel no PDF
                    const imgWidth = pageWidth - (2 * marginX);
                    let imgHeight = (mapContainer.offsetHeight / mapContainer.offsetWidth) * imgWidth;
                    
                    // Limita a altura da imagem do mapa para caber melhor na p√°gina
                    imgHeight = Math.min(imgHeight, maxMapHeightPdf);

                    // Estima a altura do bloco do mapa para a verifica√ß√£o de quebra de p√°gina
                    const estimatedMapBlockHeight = imgHeight + 20; // Altura da imagem + espa√ßo para t√≠tulo e margem

                    if (y + estimatedMapBlockHeight > pageHeight - marginYBottom) {
                        doc.addPage();
                        y = marginYTop;
                        addFooter(doc, responsavelTecnico, dataFormatada);
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor("#2e7d32");
                    doc.setFontSize(12);
                    doc.text("Localiza√ß√£o:", marginX, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    y += 5;

                    doc.addImage(mapaDataUrl, "PNG", marginX, y, imgWidth, imgHeight);
                    y += imgHeight + 5;

                    console.log("‚úÖ Mapa capturado.");
                } catch (error) {
                    console.error("‚ùå Erro ao capturar o mapa com html2canvas:", error);
                    if (y + 20 > pageHeight - marginYBottom) {
                        doc.addPage();
                        y = marginYTop;
                        addFooter(doc, responsavelTecnico, dataFormatada);
                    }
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor("#2e7d32");
                    doc.setFontSize(12);
                    doc.text("Localiza√ß√£o:", marginX, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    y += 8;
                    doc.setFontSize(9);
                    doc.text("Localiza√ß√£o n√£o dispon√≠vel.", marginX, y);
                    y += 10;
                }
            } else {
                if (y + 20 > pageHeight - marginYBottom) {
                    doc.addPage();
                    y = marginYTop;
                    addFooter(doc, responsavelTecnico, dataFormatada);
                }
                doc.setFont('helvetica', 'bold');
                doc.setTextColor("#2e7d32");
                doc.setFontSize(12);
                doc.text("Localiza√ß√£o:", marginX, y);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                y += 8;
                doc.setFontSize(9);
                doc.text("Localiza√ß√£o n√£o dispon√≠vel.", marginX, y);
                y += 10;
            }

            // --- REGISTRO FOTOGR√ÅFICO (FOR√áA NOVA P√ÅGINA) ---
            doc.addPage();
            addFooter(doc, responsavelTecnico, dataFormatada);

            doc.setFontSize(16);
            doc.text("REGISTRO FOTOGR√ÅFICO", pageWidth / 2, marginYTop, { align: "center" });

            doc.line(marginX, marginYTop + 8, pageWidth - marginX, marginYTop + 8);

            const fotos = ['foto1', 'foto2', 'foto3', 'foto4'];

            // NOVAS VARI√ÅVEIS PARA AJUSTAR O TAMANHO DAS FOTOS NO PDF
            // Reduzindo as margens e o espa√ßamento para que as fotos ocupem mais largura
            const photoSideMargin = 15;    // Margem lateral para as fotos (em vez de marginX)
            const photoColumnSpacing = 10; // Espa√ßamento entre as duas colunas de fotos
            
            // Calculando a largura dispon√≠vel para duas colunas de fotos
            // Subtraindo um pequeno valor para tentar for√ßar melhor justifica√ß√£o
            let photoColumnWidth = ((pageWidth - (2 * photoSideMargin) - photoColumnSpacing) / 2) - 2;
            let photoAspectRatio = 0.75; // Assumindo propor√ß√£o 4:3 (altura = largura = 0.75)
            let photoHeight = photoColumnWidth * photoAspectRatio;
            let currentPhotoY_photos = marginYTop + 20; // Ponto inicial Y para as fotos

            for (let i = 0; i < fotos.length; i++) {
                const id = fotos[i];
                const fileInput = document.getElementById(id);
                const description = photoDescriptions[i] || ''; // Obt√©m a descri√ß√£o
                let imageDataUrl = null;

                // Prioriza a imagem editada, se existir
                if (editedPhotoDataUrls[i]) {
                    imageDataUrl = editedPhotoDataUrls[i];
                } else if (fileInput && fileInput.files && fileInput.files[0]) {
                    try {
                        imageDataUrl = await compressImage(fileInput.files[0]);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Erro ao comprimir foto ${id}. Tentando sem compress√£o.`, error);
                        try {
                            imageDataUrl = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(fileInput.files[0]);
                            });
                        } catch (readError) {
                            console.error(`‚ùå Erro fatal ao carregar foto ${id}:`, readError);
                            imageDataUrl = null;
                        }
                    }
                }

                if (imageDataUrl) {
                    const col = i % 2;
                    let posX;
                    if (col === 0) { // Primeira coluna
                        posX = photoSideMargin;
                    } else { // Segunda coluna
                        posX = photoSideMargin + photoColumnWidth + photoColumnSpacing;
                    }

                    // Estima a altura da descri√ß√£o para verificar quebra de p√°gina
                    const descriptionLines = doc.splitTextToSize(description, photoColumnWidth);
                    const descriptionHeight = descriptionLines.length * (doc.getLineHeight() / doc.internal.scaleFactor) + 5; // +5 para padding

                    const photoBlockTotalHeight = photoHeight + descriptionHeight + 15; // Altura da foto + descri√ß√£o + espa√ßo

                    // Verifica se a pr√≥xima foto (ou par de fotos) cabe na p√°gina
                    if (col === 0 && (currentPhotoY_photos + photoBlockTotalHeight > pageHeight - marginYBottom)) {
                        doc.addPage();
                        addFooter(doc, responsavelTecnico, dataFormatada);
                        doc.setFontSize(16);
                        doc.text("REGISTRO FOTOGR√ÅFICO (Continua√ß√£o)", pageWidth / 2, marginYTop, { align: "center" });
                        doc.line(marginX, marginYTop + 8, pageWidth - marginX, marginYTop + 8);
                        currentPhotoY_photos = marginYTop + 20; // Reinicia Y para nova p√°gina
                    }

                    doc.addImage(imageDataUrl, "PNG", posX, currentPhotoY_photos, photoColumnWidth, photoHeight);
                    doc.setFontSize(9);
                    
                    // Adiciona a descri√ß√£o da foto, com alinhamento inteligente
                    if (description.trim() !== "") {
                        let currentTextY = currentPhotoY_photos + photoHeight + 5;

                        for (let lineIndex = 0; lineIndex < descriptionLines.length; lineIndex++) {
                            const line = descriptionLines[lineIndex];
                            // Sempre tenta justificar. O jsPDF lida com a √∫ltima linha curta.
                            doc.text(line, posX, currentTextY, { align: "justify", maxWidth: photoColumnWidth });
                            currentTextY += doc.getLineHeight() / doc.internal.scaleFactor;
                        }
                    }

                    if (col === 1) {
                         // Ap√≥s a segunda foto na linha, avan√ßa para a pr√≥xima linha
                         currentPhotoY_photos += photoHeight + descriptionHeight + 15; // Espa√ßo entre as linhas de fotos (foto + descri√ß√£o + espa√ßo)
                    }
                } else {
                    console.warn(`Foto ${id} n√£o p√¥de ser processada e n√£o foi adicionada ao PDF.`);
                }
            }
            console.log("üñºÔ∏è Todas as fotos foram processadas.");
            console.log("‚úÖ PDF gerado com sucesso.");

            doc.save(`relatorio_${numeroRelatorio.replace('/', '-')}.pdf`);
        }

        // NOVO EVENT LISTENER PARA O BOT√ÉO "Gerar PDF"
        document.getElementById("btnGerarPdf").addEventListener("click", async function(e) {
            e.preventDefault(); // Previne qualquer comportamento padr√£o do bot√£o

            const btn = document.getElementById('btnGerarPdf');
            const loadingMsg = document.getElementById('loadingMessage');

            const servicoSelecionado = document.getElementById('servico').value;
            let allFieldsValid = true; // Flag geral de valida√ß√£o

            // Valida√ß√£o dos campos de √°rvore dinamicamente
            let allArvoreFieldsFilled = true;
            const isPlantio = (servicoSelecionado === 'Plantio');

            if (servicoSelecionado !== '') {
                const arvoreItems = document.querySelectorAll('.arvore-item');
                if (arvoreItems.length === 0) {
                     alert("Por favor, adicione e preencha as informa√ß√µes de pelo menos uma √°rvore.");
                     return;
                }
                arvoreItems.forEach(item => {
                    const arvoreNumId = item.id.split('-')[1];
                    const especie = item.querySelector(`#especie-${arvoreNumId}`).value;
                    const quantidade = item.querySelector(`#quantidade-${arvoreNumId}`).value;
                    const posicao = item.querySelector(`#posicao-${arvoreNumId}`).value;

                    let currentTreeFieldsValid = true;
                    if (!especie || quantidade === "" || !posicao) {
                        currentTreeFieldsValid = false;
                    }

                    if (isPlantio) {
                        const aberturaAreaLivre = item.querySelector(`#aberturaAreaLivre-${arvoreNumId}`).value;
                        const larguraCalcadaInput = item.querySelector(`#larguraCalcada-${arvoreNumId}`);
                        const larguraCalcada = larguraCalcadaInput.value;

                        // A largura da cal√ßada s√≥ √© obrigat√≥ria se estiver vis√≠vel
                        const isLarguraCalcadaVisible = larguraCalcadaInput.style.display !== 'none';

                        if (!aberturaAreaLivre || (isLarguraCalcadaVisible && larguraCalcada === "")) {
                            currentTreeFieldsValid = false;
                        }
                    } else {
                        const altura = item.querySelector(`#altura-${arvoreNumId}`).value;
                        if (altura === "") { // Altura √© obrigat√≥ria para n√£o-plantio
                            currentTreeFieldsValid = false;
                        }
                    }

                    if (!currentTreeFieldsValid) {
                        allArvoreFieldsFilled = false;
                        item.style.border = '22px solid red';
                    } else {
                        item.style.border = '1px solid #e0e0e0';
                    }
                });
            }

            if (!allArvoreFieldsFilled) {
                alert("Por favor, preencha todos os campos obrigat√≥rios das √°rvores (incluindo informa√ß√µes de plantio, se aplic√°vel).");
                return;
            }

            // --- NOVA VALIDA√á√ÉO: Diagn√≥stico e Indica√ß√£o para servi√ßos que n√£o sejam 'Plantio' ---
            let allDiagnosesIndicationsFilled = true;
            if (!isPlantio) { // Apenas valida se o servi√ßo n√£o for "Plantio"
                arvoresData.forEach(arvore => {
                    const arvoreItemElement = document.getElementById(arvore.id);
                    if (arvore.diagnoses.length === 0) {
                        allDiagnosesIndicationsFilled = false;
                        if (arvoreItemElement) arvoreItemElement.style.border = '2px solid orange'; // Destaca a √°rvore com erro
                    } else if (arvoreItemElement) {
                         arvoreItemElement.style.border = '1px solid #e0e0e0'; // Remove destaque se j√° foi corrigido
                    }

                    if (arvore.indications.length === 0) {
                        allDiagnosesIndicationsFilled = false;
                        if (arvoreItemElement) arvoreItemElement.style.border = '2px solid orange'; // Destaca a √°rvore com erro
                    } else if (arvoreItemElement) {
                         arvoreItemElement.style.border = '1px solid #e0e0e0'; // Remove destaque se j√° foi corrigido
                    }
                });

                if (!allDiagnosesIndicationsFilled) {
                    alert("Para servi√ßos que n√£o s√£o 'Plantio', por favor, adicione pelo menos um 'Diagn√≥stico' e uma 'Indica√ß√£o' para cada √°rvore. As √°rvores com campos pendentes foram destacadas.");
                    return; // Interrompe a submiss√£o
                }
            }


            // --- VALIDA√á√ÉO CONDICIONAL PARA O CAMPO DE REFER√äNCIA (N√öMERO) ---
            const numeroRef = document.getElementById('numeroReferencia').value.trim();
            const tipoRef = document.getElementById('tipoReferencia').value;

            if (tipoRef !== "Demanda Interna" && numeroRef === "") {
                alert(`Por favor, digite o n√∫mero para ${tipoRef}.`);
                document.getElementById('numeroReferencia').focus();
                return;
            }

            btn.disabled = true;
            loadingMsg.style.display = 'block';

            try {
                await gerarPDF();

            } catch (error) {
                console.error("Erro geral ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF. Verifique o console para mais detalhes.");
            } finally {
                btn.disabled = false;
                loadingMsg.style.display = 'none';
            }
        });


        // --- FUN√á√ÉO ADICIONADA: Limpa o formul√°rio, EXCETO o n√∫mero do relat√≥rio ---
        function resetFormularioAposPdf() {
            // Limpa o array de dados das √°rvores e o container HTML
            arvoresData = [];
            document.getElementById('arvoresContainer').innerHTML = '';
            arvoreCounter = 0; // Resetar o contador de IDs para que a primeira √°rvore seja 'arvore-1'
            addArvoreFields(); // Adiciona uma nova √°rvore vazia como a primeira

            // Limpa campos principais do formul√°rio
            document.getElementById('tipoReferencia').value = 'Processo'; // Volta para o default, ou pode ser ''
            document.getElementById('numeroReferencia').value = '';
            document.getElementById('servico').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('tecnico').value = '';
            document.getElementById('dataFinal').value = ''; // Limpa a data

            // Limpa localiza√ß√£o
            if (mapa) { // Verifica se o mapa foi inicializado
                mapa.remove(); // Remove o mapa Leaflet
                mapa = null;
            }
            marcador = null; // Reinicia o marcador
            latGlobal = null;
            lngGlobal = null;
            document.getElementById('loadingLocation').style.display = 'none'; // Esconde mensagem de loading de localiza√ß√£o

            // Limpa as entradas de fotos e previews
            const inputFotos = ['foto1', 'foto2', 'foto3', 'foto4'];
            inputFotos.forEach((id, index) => {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    inputElement.value = ''; // Limpa o input file
                }
                // Limpa a descri√ß√£o e a imagem editada
                document.getElementById(`descricao${id.charAt(0).toUpperCase() + id.slice(1)}`).value = '';
                photoDescriptions[index] = '';
                editedPhotoDataUrls[index] = null;
            });
            document.getElementById('previewFotos').innerHTML = ''; // Limpa as pr√©-visualiza√ß√µes

            // Garante que o input de n√∫mero de refer√™ncia condicional seja ocultado novamente, se "Demanda Interna" for o default
            const tipoRef = document.getElementById('tipoReferencia').value;
            if (tipoRef === "Demanda Interna") {
                document.getElementById('numeroReferencia').style.display = 'none';
                document.getElementById('numeroReferencia').removeAttribute('required');
            } else {
                document.getElementById('numeroReferencia').style.display = 'block';
                document.getElementById('numeroReferencia').setAttribute('required', 'required');
            }
            // Chama applyTreeFieldVisibility para garantir que o estado inicial dos campos da √°rvore esteja correto
            applyTreeFieldVisibility();

            // --- ALTERA√á√ÉO AQUI: Atualiza o n√∫mero do relat√≥rio ao limpar o formul√°rio ---
            incrementAndDisplayNextReportNumber();

            // Substitu√≠do alert por console.log para n√£o interromper o fluxo
            console.log("Formul√°rio limpo! Pronto para registrar a pr√≥xima √°rvore. O n√∫mero do relat√≥rio foi atualizado.");
        }

        // --- EVENT LISTENER PARA O NOVO BOT√ÉO DE LIMPAR ---
        document.getElementById('limparParaProximaArvoreBtn').addEventListener('click', resetFormularioAposPdf);
    </script>
</body>
</html>
